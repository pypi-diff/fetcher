 #!/bin/bash
set -e
source ../pypidiff/token
export GIT_SSH_COMMAND="ssh -i ../pypidiff/diffbot.key"

TODAY=$(date +'%Y%m%d')
YESTERDAY=$(date +'%Y%m%d' -d 'yesterday')
NOW=$(date +'%Y%m%d%H%M')

LIST=$(mktemp)
gh repo list pypi-diff > $LIST

if ! grep $TODAY $LIST > /dev/null; then
    echo "Create new repo $TODAY"
    gh repo create pypi-diff/$TODAY --public -p  pypi-diff/template -d "Daily generated diffs for pypi package releases"
    # cloning from template takes some time
    sleep 20

    git clone ssh://git@github.com/pypi-diff/$TODAY

    if [ -e $YESTERDAY/serial ]; then
        cp $YESTERDAY/serial $TODAY/serial
    fi

    # start workflows for scanning results
    gh workflow run -R github.com/pypi-diff/$YESTERDAY gh-secrets-scanner
fi

rm -f $LIST

if [ ! -e $TODAY ]; then
    git clone ssh://git@github.com/pypi-diff/$TODAY
fi

python3 fetch.py --serial $TODAY/serial --output $TODAY --logfile $TODAY/fetcher.log

# do not try to hit any limits ..
find $TODAY  -type f ! -name "*.gz" -and -size +50M -exec gzip {} \;
PARM="--git-dir $TODAY/.git --work-tree $TODAY"
git $PARM config user.name "pypidiff"
git $PARM config user.email "fbonly@schiach.de"
git $PARM add .
git $PARM commit -m "changes: $NOW" -a
git $PARM push
git $PARM tag -a "v$NOW" -m "$NOW"
git $PARM push origin "v$NOW"
